name: Frontend CI/CD

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

env:
  NODE_VERSION: "20"
  REMOTE_DIR: /home/ubuntu/opt/fe-prod
  ARTIFACT_FILE: next-build.tar.gz

jobs:
  ci:
    name: CI (format/lint/build)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      #      - name: Check formatting (Prettier)
      #        run: npm run format:check

      - name: Run Lint (ESLint)
        run: npm run lint

      # í…ŒìŠ¤íŠ¸ ë„ì… ì „ì´ë©´ ì£¼ì„ ìœ ì§€ ì¶”í›„ ë„ì…
      # - name: Run Unit Tests
      #   run: npm run test

      - name: Build Next.js App
        env:
          NEXT_PUBLIC_KAKAO_CLIENT_ID: ${{ secrets.NEXT_PUBLIC_KAKAO_CLIENT_ID }}
          NEXT_PUBLIC_KAKAO_REDIRECT_URI: ${{ secrets.NEXT_PUBLIC_KAKAO_REDIRECT_URI }}
          NEXT_PUBLIC_API_BASE_URL: ${{ secrets.NEXT_PUBLIC_API_BASE_URL }}
        run: npm run build

      - name: Package Next.js build (non-standalone)
        run: |
          rm -rf deploy_fe
          mkdir -p deploy_fe
          
          # ë¹Œë“œ ì‚°ì¶œë¬¼ ì „ì²´
          cp -r .next deploy_fe/.next
          
          # public (ì‚¬ìš©í•˜ë©´)
          if [ -d "public" ]; then
          cp -r public deploy_fe/public
          fi
          
          # ì‹¤í–‰ì— í•„ìš”í•œ íŒŒì¼ë“¤
          cp package.json deploy_fe/package.json
          
          # lockfileë„ ê°™ì´ ë„£ëŠ” ê²Œ ì•ˆì „
          if [ -f package-lock.json ]; then
          cp package-lock.json deploy_fe/package-lock.json
          fi
          
          # next.config.* í•„ìš”í•  ìˆ˜ë„ ìˆìŒ(ëŸ°íƒ€ì„ì—ì„œ ì°¸ì¡°í•˜ëŠ” ê²½ìš°)
          if [ -f next.config.js ]; then cp next.config.js deploy_fe/next.config.js; fi
          if [ -f next.config.mjs ]; then cp next.config.mjs deploy_fe/next.config.mjs; fi
          
          tar -czf next-build.tar.gz -C deploy_fe .

      - name: Upload bundle to server (SCP)
        if: github.event_name == 'push'
        # if: github.event_name == 'push' && github.ref_name == 'develop'

        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.FRONT_PROD_SERVER_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: ${{ env.ARTIFACT_FILE }}
          target: ${{ env.REMOTE_DIR }}/incoming/

  deploy:
    name: CD (prod deploy)
    runs-on: ubuntu-latest
    needs: [ci]
    if: github.event_name == 'push' && needs.ci.result == 'success'
    #    if: github.event_name == 'push' && github.ref_name == 'develop' && needs.ci.result == 'success'

    steps:
      - name: Deploy via SSH (run deploy.sh)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.FRONT_PROD_SERVER_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script_stop: true
          script: |
            set -e
            cd ${{ env.REMOTE_DIR }}

            echo "Artifact: ${{ env.REMOTE_DIR }}/incoming/${{ env.ARTIFACT_FILE }}"

            chmod +x deploy.sh
            ./deploy.sh "${{ env.REMOTE_DIR }}/incoming/${{ env.ARTIFACT_FILE }}"

  k6_test:
    needs: deploy
    runs-on: ubuntu-latest
    if: github.ref_name == 'main'
    steps:
      - uses: actions/checkout@v4
      - uses: grafana/setup-k6-action@v1

      - name: k6-home-test
        uses: grafana/run-k6-action@v1
        env:
          URL: ${{ secrets.HOME_URL}}
          ACCESS_TOKEN: ${{ secrets.ACCESS_TOKEN }}
        with:
          path: tests/page_loading.js

      - name: k6-group-detail-test
        uses: grafana/run-k6-action@v1
        env:
          URL: ${{ secrets.GROUP_DETAIL_URL }}
          ACCESS_TOKEN: ${{ secrets.ACCESS_TOKEN }}
        with:
          path: tests/page_loading.js
            

  notify:
    name: Notify Discord
    runs-on: ubuntu-latest
    needs: [ci, deploy]
    if: always()

    steps:
      - name: Send notification
        run: |
          CI_RESULT="${{ needs.ci.result }}"
          DEPLOY_RESULT="${{ needs.deploy.result }}"
          K6_RESULT="${{ needs.k6_test.result }}"
          REF="${{ github.repository }}@${{ github.ref_name }}"
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"username\":\"Frontend CI/CD\",\"content\":\"ğŸ–¥ï¸ Frontend CI/CD ê²°ê³¼\\n- CI: **${CI_RESULT}**\\n- Deploy: **${DEPLOY_RESULT}**\\n- K6: **${K6_RESULT}**\\nğŸ”— [${REF}](${RUN_URL})\"}" \
               ${{ secrets.DISCORD_WEBHOOK_URL }}